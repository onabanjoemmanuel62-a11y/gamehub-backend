<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="admin.css" />
</head>
<body>
  <div class="sidebar">
    <h2>‚öôÔ∏è Admin</h2>
    <ul>
      <li><a href="/admin.html">Manage Games</a></li>
      <li><a href="/admin-orders.html">üì¶ View Orders</a></li>
      <li><a href="/logout">Logout</a></li>
    </ul>
  </div>

  <div class="main">
    <header><h1>Game Management</h1></header>

    <section class="game-table">
      <table>
        <thead>
          <tr>
            <th>Game</th>
            <th>Price ($)</th>
            <th>Current image</th>
            <th>New image</th>
            <th>Category</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="game-list"></tbody>
      </table>
    </section>

    <section class="add-game">
      <h2>Add New Game</h2>
      <form id="addForm" enctype="multipart/form-data">
        <input type="text" name="name" id="newName" placeholder="Game Name" required />
        <input type="number" name="price" id="newPrice" placeholder="Price" step="0.01" required />
        <input type="file" name="image" id="newImage" accept="image/*" />
        <input type="text" name="category" id="newCategory" placeholder="Category (e.g. Xbox, PlayStation, PC)" required />
        <button type="submit">Add Game</button>
      </form>
    </section>
  </div>

  <script>
    async function loadGames() {
      const res = await fetch('https://gamehub-backend-a0c2.onrender.com/games.json', { cache: 'no-store', credentials: 'include' });
      if (!res.ok) {
        alert('Could not load games. Are you logged in?');
        return;
      }
      const games = await res.json();
      const list = document.getElementById('game-list');
      list.innerHTML = '';
      games.forEach(g => {
        list.innerHTML += `
          <tr>
            <td>${g.name}</td>
            <td><input type="number" id="price-${g.id}" value="${Number(g.price)}" step="0.01" /></td>
            <td>${g.image ? `<img src="${g.image}" alt="${g.name}" width="60" height="60" style="object-fit:cover;border-radius:6px;">` : 'No image'}</td>
            <td><input type="file" id="image-${g.id}" accept="image/*" /></td>
            <td><input type="text" id="category-${g.id}" value="${g.category || ''}" /></td>
            <td>
              <button onclick="updateGame(${g.id})">Update</button>
              <button onclick="deleteGame(${g.id})" style="background:#ff4444;">Delete</button>
            </td>
          </tr>`;
      });
    }

    async function updateGame(id) {
      const priceInput = document.getElementById('price-' + id);
      const fileInput = document.getElementById('image-' + id);
      const categoryInput = document.getElementById('category-' + id);

      const price = parseFloat(priceInput.value);
      if (Number.isNaN(price)) {
        alert('Please enter a valid price.');
        return;
      }

      const formData = new FormData();
      formData.append('id', String(id));
      formData.append('price', String(price));
      formData.append('category', categoryInput.value);
      if (fileInput.files && fileInput.files[0]) {
        formData.append('image', fileInput.files[0]);
      }

      const res = await fetch('https://gamehub-backend-a0c2.onrender.com/update-game', {
        method: 'POST',
        body: formData,
        credentials: 'include'
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert('Update failed: ' + (err.error || res.statusText));
        return;
      }
      loadGames();
    }

    async function deleteGame(id) {
      const res = await fetch('https://gamehub-backend-a0c2.onrender.com/delete-game', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id }),
        credentials: 'include'
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert('Delete failed: ' + (err.error || res.statusText));
        return;
      }
      loadGames();
    }

    async function addGame(e) {
      e.preventDefault();
      const form = document.getElementById('addForm');
      const formData = new FormData(form);

      const res = await fetch('https://gamehub-backend-a0c2.onrender.com/add-game', {
        method: 'POST',
        body: formData,
        credentials: 'include'
      });

      if (res.ok) {
        form.reset();
        loadGames();
      } else {
        const err = await res.json().catch(() => ({}));
        alert('Failed to add game: ' + (err.error || res.statusText));
      }
    }

    document.getElementById('addForm').addEventListener('submit', addGame);
    window.onload = loadGames;
  </script>
</body>
</html>
